# Database Migrations with Alembic

This directory contains database migration scripts for PromptForge using Alembic.

## Quick Start

### Running Migrations in Production

```bash
# Apply all pending migrations
./migrate.sh upgrade

# Check current migration status
./migrate.sh current

# View migration history
./migrate.sh history
```

### Creating New Migrations

```bash
# Create a new migration with autogenerate
./migrate.sh create "add user preferences table"

# Or use alembic directly
alembic revision --autogenerate -m "add user preferences table"
```

## Migration Commands

The `migrate.sh` helper script provides the following commands:

- **upgrade**: Apply all pending migrations (default)
  ```bash
  ./migrate.sh upgrade
  ```

- **downgrade [N]**: Revert N migrations (default: 1)
  ```bash
  ./migrate.sh downgrade 1
  ```

- **current**: Show current database revision
  ```bash
  ./migrate.sh current
  ```

- **history**: Show complete migration history
  ```bash
  ./migrate.sh history
  ```

- **check**: Check for pending migrations
  ```bash
  ./migrate.sh check
  ```

- **create "message"**: Create new migration with autogenerate
  ```bash
  ./migrate.sh create "your migration message"
  ```

## Using Alembic Directly

### Upgrade to latest
```bash
alembic upgrade head
```

### Upgrade by one revision
```bash
alembic upgrade +1
```

### Downgrade by one revision
```bash
alembic downgrade -1
```

### Downgrade to specific revision
```bash
alembic downgrade abc123
```

### Show current revision
```bash
alembic current
```

### Show revision history
```bash
alembic history --verbose
```

### Create new migration (autogenerate)
```bash
alembic revision --autogenerate -m "description"
```

### Create empty migration
```bash
alembic revision -m "description"
```

## Production Deployment Workflow

### Initial Deployment

1. Set up your production database and configure DATABASE_URL
2. Run migrations to create all tables:
   ```bash
   ./migrate.sh upgrade
   ```

### Updating Existing Deployment

1. Pull latest code with new migrations
2. Check pending migrations:
   ```bash
   ./migrate.sh check
   ```
3. Apply pending migrations:
   ```bash
   ./migrate.sh upgrade
   ```
4. Restart application

### Rollback Procedure

If a migration causes issues:

1. Stop the application
2. Rollback the migration:
   ```bash
   ./migrate.sh downgrade 1
   ```
3. Redeploy previous application version
4. Restart application

## Environment Variables

Alembic uses the `DATABASE_URL` from your application settings. Ensure this is set before running migrations:

```bash
export DATABASE_URL="postgresql://user:password@localhost:5432/promptforge"
./migrate.sh upgrade
```

Or in production with .env file:
```bash
source .env.production
./migrate.sh upgrade
```

## Migration File Structure

```
alembic/
├── versions/           # Migration scripts
│   └── xxxx_initial_migration.py
├── env.py             # Alembic environment configuration
├── script.py.mako     # Template for new migrations
└── README.md          # This file
```

## Best Practices

1. **Always review autogenerated migrations** - Alembic may not detect all changes correctly
2. **Test migrations on staging** - Never run untested migrations in production
3. **Keep migrations atomic** - Each migration should handle a single logical change
4. **Write reversible migrations** - Always implement both upgrade() and downgrade()
5. **Backup before migration** - Always backup production database before applying migrations
6. **Run migrations during maintenance** - Apply migrations during low-traffic periods

## Troubleshooting

### Migration fails with "target database is not up to date"

This means your database is not at the expected revision. Check current revision:
```bash
alembic current
```

Then either upgrade to latest or downgrade to match expected state.

### Autogenerate doesn't detect my model changes

1. Ensure models are imported in `app/models/__init__.py`
2. Verify `env.py` imports all models
3. Check that models inherit from `Base`
4. Some changes (like column renames) may need manual migration edits

### Can't connect to database

Ensure DATABASE_URL is set correctly:
```bash
echo $DATABASE_URL
```

### Migration conflicts

If multiple developers create migrations, you may need to merge them:
```bash
alembic merge heads -m "merge migrations"
```

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [FastAPI Database Documentation](https://fastapi.tiangolo.com/tutorial/sql-databases/)
